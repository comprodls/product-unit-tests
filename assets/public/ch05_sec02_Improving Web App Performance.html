<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Improving Web App Performance With the Chrome DevTools Timeline and Profiles</title>
        <link rel="stylesheet" type="text/css" href="css/core.css"/>
    </head>
    <body>
        <div class="chaptertitle">
            <h2 class="title">Improving Web App Performance With the Chrome DevTools Timeline and Profiles</h2>
        </div>


            <div class="figure">
                <span id="reference-diagram" />
                    <div class="figure-contents">

                        <p>

                            <img alt="" class="alignleft size-full wp-image-5036" src="images/ch05_sec02_webapp1.jpg" title="record" height="342" border="0" width="540">
                        </p>
                    </div>
             
            </div>
            <p>
                We all want to create high performance web applications. As our apps get more complex, we may want to support<strong>&nbsp;rich animations </strong>and that ideal <strong>60</strong> frames a second that keep our apps<strong> responsive </strong>and <strong>snappy</strong>. &nbsp;
            </p>
            <p>
                Being aware of how to measure and improve performance can be a useful skill and in&nbsp;this short post, I'll give you a quick refresher on how this can be done with the Chrome DevTools <a class="ulink" href="https://developers.google.com/chrome-developer-tools/docs/timeline">Timeline</a> and <a class="ulink" href="https://developers.google.com/chrome-developer-tools/docs/profiles">Profiles</a>.</p><p><span id="more-4957"></span></p><p><span style="font-size:10px;">Look! It's a beautiful animated GIF. It's a sign this post is going downhil from here : )</span>
            </p>
            <div class="figure">
                <span id="reference-diagram" />
                    <div class="figure-contents">
                        <img alt="" class="aligncenter" src="images/ch05_sec02_zR2f1.gif" title="Chrome DevTools timeline" height="281" width="500">
                    </div>
             
            </div>

        <div class="sub_section">
            <h2>Record</h2>
            <p>
                The Timeline panel provides an overview of where time is spent loading up your web application such as how long it takes to process <strong>DOM events</strong>, <strong>render</strong> <strong>page layouts</strong> or <strong>paint elements</strong> to the screen.</p>
            <div class="figure">
                <span id="reference-diagram" />
                    <div class="figure-contents">
                         <p>
                            <img alt="" class="aligncenter size-full wp-image-4987" src="images/ch05_sec02_Screen-Shot-2012-12-10-at-10.png" title="Screen Shot 2012-12-10 at 10.15.47" height="69" width="313">
                        </p>
                     </div>
            </div>

            <p>
                It allows you to drill down into three separate facets that can help discover why your application is slow: <strong>Events</strong>, <strong>Frames</strong> and actual<strong> Memory </strong>usage.&nbsp;To get started, navigate to your app and switch to the Timeline panel within the DevTools.
            </p>
            <div class="figure">
                <span id="reference-diagram" />
                    <div class="figure-contents">


                        <p>
                            <img alt="" class="aligncenter size-full wp-image-4968" src="images/ch05_sec02_Screen-Shot-2012-12-10-at-00.png" title="Screen Shot 2012-12-10 at 00.19.49" height="239" width="530">
                        </p>
                    </div>
            </div>

            <p>Timeline won’t display any data by default but you can begin a recording session with it by opening your app and clicking on the gray circle ☻ at the bottom of the pane – using&nbsp;the&nbsp;<strong>Cmd/Ctrl+E </strong>shortcut<strong>&nbsp;</strong>will also trigger a record.&nbsp;
            </p>

            <div class="figure">
                <span id="reference-diagram" />
                    <div class="figure-contents">
                        <p>
                            <img alt="" class="aligncenter size-full wp-image-4980" src="images/ch05_sec02_Screen-Shot-2012-12-10-at-00_010.png" title="Screen Shot 2012-12-10 at 00.37.24" height="33" width="226">
                        </p>
                    </div>
            </div>


                <p>This record button will turn from gray to red and the Timeline will begin to capture the timelines for your page. Complete a few actions inside your app and after a few seconds, click the button again to stop recording.</p>
                
                <p>Note:&nbsp;
                            
                                        <img alt="" class="size-full wp-image-5021" src="images/ch05_sec02_Screen-Shot-2012-12-10-at-15_003.png" title="Screen Shot 2012-12-10 at 15.08.47" height="25" width="30">
                                
                            

                &nbsp;will clear your current recording session so you can begin a new one.&nbsp;

                           
                                            <img alt="" class="size-full wp-image-5022" src="images/ch05_sec02_Screen-Shot-2012-12-10-at-15_005.png" title="Screen Shot 2012-12-10 at 15.08.54" height="26" width="30">
                                            
                           

                &nbsp;will force V8 to complete a round of garbage collection, which is useful during debugging.&nbsp;

                                            <img alt="" class="size-full wp-image-5023" src="images/ch05_sec02_Screen-Shot-2012-12-10-at-15.png" title="Screen Shot 2012-12-10 at 15.12.31" height="27" width="36">
                                    

                &nbsp;will filter the Details view to only display those records taking longer than 15ms to complete.


                </p>
                    
        </div>
        <div class="sub_section">

            <h2>Examine</h2>
            <p>
                Next,we're going to move onto examining the data recorded. Prioritize what your performance costs are. Is it your JavaScript? Is it your rendering?We’re going to first look at the Timeline Events mode, which can help answer these questions.
            </p>
            <div class="figure">
                <span id="reference-diagram" />
                    <div class="figure-contents">
                        <p>
                             <img alt="" class="aligncenter size-full wp-image-4965" src="images/ch05_sec02_Screen-Shot-2012-12-08-at-21_004.png" title="Screen Shot 2012-12-08 at 21.42.26" height="228" width="530">
                        </p>
                     </div>
            </div>
            <p>
                In this mode, the Summary view (at the top of the Timeline) displays horizontal bars representing the <strong>network and HTML parsing</strong> (blue), <strong>JavaScript</strong> (yellow), <strong>style recalculation and layout </strong>(purple) and <strong>painting and compositing</strong>(green) events for your page. Repaints are browser events invoked by responses to visual changes such as window resizes or scrolls.
            </p>
            <p>
                Recalculations occur due to modifications of CSS properties whilst Layout events (or reflows) are due to changes in element position. Don't worry if you can't remember these as the legend lower down in the Timeline panel covers these.
            </p>
            <div class="figure">
                <span id="reference-diagram" />
                    <div class="figure-contents">
                        <p>
                            <img alt="" class="aligncenter size-full wp-image-4966" src="images/ch05_sec02_Screen-Shot-2012-12-08-at-21_002.png" title="Screen Shot 2012-12-08 at 21.44.30" >
                        </p>
                    </div>
            </div>
            <p>Below the Summary view is the Details view, which includes detailed records for these categories after a session has been recorded.</p>
            <div class="figure">
                <span id="reference-diagram" />
                    <div class="figure-contents">
                        <p>
                        <img alt="" class="aligncenter size-full wp-image-4970" src="images/ch05_sec02_Screen-Shot-2012-12-10-at-00_003.png" title="Screen Shot 2012-12-10 at 00.24.33" height="194" width="452">
                         </p>
                    </div>
             
            </div>
            <p>
                Each record has a title describing it to the left and timeline bars to the right. Hovering over a record will display an extended tooltip with details about the time taken to complete it – these have <strong>so much</strong>&nbsp;useful information in there, so do pay attention to them, especially the Call Stack.
            </p>
            <div class="figure">
                <span id="reference-diagram" />
                    <div class="figure-contents">
                        <p>
                            <img alt="" class="aligncenter size-full wp-image-4971" src="images/ch05_sec02_Screen-Shot-2012-12-08-at-21_003.png" title="Screen Shot 2012-12-08 at 21.47.05" height="253" width="378">
                         </p>
                    </div>
             
            </div>
            <p>
                Clicking on Call Stack or location hyperlinks within these tooltips will take you to the exact line of JavaScript responsible for the behaviour. If you find that a browser event takes an excessive amount of time to complete (which you can determine from the ‘Duration’ in the details tooltip), you may want to investigate further as to why this is.
            </p>
            <div class="figure">
                <span id="reference-diagram" />
                    <div class="figure-contents">
                        <p>
                            <img alt="" class="aligncenter size-full wp-image-4972" src="images/ch05_sec02_Screen-Shot-2012-12-10-at-00_004.png" title="Screen Shot 2012-12-10 at 00.27.29" height="96" width="370">
                        </p>
                    </div>
             
            </div>

            <p>Back to records, whilst clicking on a record expands it, providing further records about the events it was composed of.</p>
            <p>
                <img alt="" class="aligncenter size-full wp-image-4992" src="images/ch05_sec02_Screen-Shot-2012-12-10-at-10_003.png" title="Screen Shot 2012-12-10 at 10.48.55" height="51" width="380">
            </p>
            <p>
                If you’re only interested in a specific section of data, click and drag within the Summary view to select a range to zoom into.
            </p>
            <div class="figure">
                <span id="reference-diagram" />
                    <div class="figure-contents">
                        <p>
                            <img alt="" class="aligncenter size-full wp-image-4993" src="images/ch05_sec02_Screen-Shot-2012-12-10-at-10_002.png" title="Screen Shot 2012-12-10 at 10.51.34" height="115" width="160">
                        </p>
                    </div>
             
            </div>

            <h3>Improving frame rate, animations and responsiveness</h3>

            <p>
                <a class="ulink" href="http://blog.chromium.org/2012/11/build-smoother-web-apps-with-chrome.html">Frames mode</a>gives you insight into the tasks Chrome had to perform to generate a single frame (update) of your application for presentation on the screen.
            </p>
            <div class="figure">
                <span id="reference-diagram" />
                    <div class="figure-contents">
            <p>
                <img alt="" class="aligncenter size-full wp-image-4974" src="images/ch05_sec02_Screen-Shot-2012-12-10-at-00_009.png" title="Screen Shot 2012-12-10 at 00.30.30" height="243" width="530"></p>
                 </div>
             
            </div>
            <p>
                For a really smooth experience, you want some consistency with the frame rate you’re achieving – ideally want to be hitting 30-60fps and if you’re hitting much lower than this then your application is going to appear <a class="ulink" href="http://jankfree.com/">janky</a> or jittery as frames are being missed.&nbsp;</p>
            <p>
                InFrame mode, the shaded vertical bars correspond to recalculating styles, compositing and so on. The transparent areas of each vertical bar correspond to idle time, at least, idle on the part of your page.&nbsp;For example, say your first frame takes 15ms to execute and the next takes 30ms. A common situation is that frames are synchronized to refresh rate and in this case, the second frame took slightly longer than 15ms to render. Here, frame 3 missed the "true" hardware frame and was rendered upon the next frame, hence, the length of the second frame was effectively doubled.&nbsp;
            </p>
            <div class="figure">
                <span id="reference-diagram" />
                    <div class="figure-contents">
                         <p>
                            <img alt="" class="size-full wp-image-5040" src="images/ch05_sec02_Screen-Shot-2012-12-10-at-18.png" title="Screen Shot 2012-12-10 at 18.23.46" height="126" width="530">
                        </p>
                    </div>
             
            </div>
            <p>
                As Andrey Kosyakov mention on the <a class="ulink" href="http://blog.chromium.org/2012/11/build-smoother-web-apps-with-chrome.html">Chromium</a>blog, even if your app doesn't have a lot of animation in it, the idea of frames is useful as the browser has to perform a repeated sequence of actions while processing input events. When you leave enough time to process such events in a frame, it makes your app more responsive, meaning a better user experience.
            </p>
            <div class="figure">
                <span id="reference-diagram" />
                    <div class="figure-contents">
                         <p>
                            <img alt="" class="aligncenter size-full wp-image-4977" src="images/ch05_sec02_Screen-Shot-2012-12-10-at-00_002.png" title="Screen Shot 2012-12-10 at 00.34.52" height="89" width="267">
                        </p>
                    </div>
             
            </div>
            <p>
                When we target 60fps, we have a max of <a class="ulink" href="http://blog.artillery.com/2012/10/browser-garbage-collection-and-framerate.html">16.66ms</a>to do everything. That's not a lot of time and so squeezing as much performance out of your animations as possible is important.</p><p>Again,by zooming into frames that aren’t hitting your target frame rate in the Summary view, you can discover what browser (and application behaviour) is causing you pain.</p>
            <div class="figure">
                <span id="reference-diagram" />
                    <div class="figure-contents">
                        <p>
                            <img alt="" class="aligncenter size-full wp-image-4978" src="images/ch05_sec02_Screen-Shot-2012-12-10-at-00_007.png" title="Screen Shot 2012-12-10 at 00.35.58" height="131" width="187">
                        </p>
                    </div>
             
            </div>
            <p>
                For example, we recently used Frames (and Events) view to discover that in one of our apps there were an excessive number of image decodes occurring because the browser was constantly having to rescale our images on the fly.
            </p>
            <div class="figure">
                <span id="reference-diagram" />
                    <div class="figure-contents">
                        <p>
                             <img alt="" class="aligncenter size-full wp-image-5010" src="images/ch05_sec02_Screen-Shot-2012-12-10-at-11_008.png" title="Screen Shot 2012-12-10 at 11.38.03" height="117" width="367">
                        </p>
                    </div>
             
            </div>
            <p>By instead using prescaled images of the dimensions we actually needed, we avoided this overhead and managed to hit 60fps, which was a lot more smooth for the end-user.</p><p>Related tip: You can enable a real-time FPS counter from within the DevTools by going to the Settings menu and enabling <em>Show FPS meter.</em></p>
            <div class="figure">
                <span id="reference-diagram" />
                    <div class="figure-contents">
                        <p>
                             <img alt="" class="size-full wp-image-5032" src="images/ch05_sec02_Screen-Shot-2012-12-10-at-15_004.png" title="Screen Shot 2012-12-10 at 15.39.14" height="109" width="292"></p>
                    </div>
             
            </div>
            <p>

                This will display a meter as follows in the top right corner of your application, meaning you can get a visual feedback loop on when your frame rate is dropping below your desired target rates.
            </p>
            <div class="figure">
                <span id="reference-diagram" />
                    <div class="figure-contents">
                         <p>
                            <img alt="" class="size-full wp-image-5033" src="images/ch05_sec02_Screen-Shot-2012-12-10-at-15_002.png" title="Screen Shot 2012-12-10 at 15.39.33" height="74" width="175">
                        </p>
                     </div>
             
            </div>
            <p>
                <strong>Mobile</strong>
            </p>
            <p>
                Note that on mobile, as Paul <a class="ulink" href="https://www.youtube.com/watch?feature=player_detailpage&amp;v=WpqZ0LjNU5A#t=1942s">demonstrated</a>in the Breakpoint Ep 4, animations and frame rate are very different than on desktop by several orders of magnitude. Achieving a higher frame-rate is difficult there and tools like the Timeline Frame mode (coupled with <a class="ulink" href="https://developers.google.com/chrome/mobile/docs/debugging">remote debugging</a>) can help you diagnose what your bottlenecks are.</p>
            <p>
            <strong>Long-paints are difficult</strong>
            </p>
            <p>
                Diagnosing paints that take a while can be another challenge. If you find yourself wanting to know why the paint for a specific element is slow, set parts of the DOM to <code>display:none</code> to remove it from Layout/Reflow and <code>visibility:hidden</code>to remove from Paint. You can then measure it by taking a Timeline recording and noting paint times, then viewing the (experimental) paint rate in Force Repaint Mode (thanks to Paul for that tip!).
            </p>

            <h3>Decreasing memory use and avoiding the sawtooth curve</h3>
            <p>Memory mode is useful for diagnosing the initial symptoms that your app might be suffering from a memory leak.</p>
            <div class="figure">
                <span id="reference-diagram" />
                    <div class="figure-contents">
                        <p>
                            <img alt="" class="aligncenter size-full wp-image-4982" src="images/ch05_sec02_Screen-Shot-2012-12-10-at-00_005.png" title="Screen Shot 2012-12-10 at 00.39.47" height="83" width="530">
                         </p>
                    </div>
             
            </div>
            <p>
                To use it, record once more some of your interactions with the application for a few minutes then stop and examine. What you’ll notice in the Summary view is the memory usage for those actions as you moved between different parts of the app. There will be both usage increase as well as normal garbage collection occurring.
            </p>
            <p>
                The area in<strong> light blue</strong>represents the amount of memory used by your application at a given time whilst the white area is the total amount of memory that has been allocated.
            </p>
            <p>
                If you notice a <a class="ulink" href="http://blog.tojicode.com/2012/03/javascript-memory-optimization-and.html">sawtooth graph</a> in the Summary view, this represents the cost of business. For example, an empty <a class="ulink" href="http://paulirish.com/2011/requestanimationframe-for-smart-animating/">requestAnimationFrame</a>will give you garbage, however it’s the steepness of your sawtooth that you need to keep an eye on. If it’s getting really sharp, you’re generating a great deal of garbage.
            </p>
            <div class="figure">
                <span id="reference-diagram" />
                    <div class="figure-contents">
                         <p>
                            <img alt="" class="aligncenter size-full wp-image-4962" src="images/ch05_sec02_Screen-Shot-2012-12-08-at-21.png" title="Screen Shot 2012-12-08 at 21.51.32" height="63" width="316">
                        </p>
                    </div>
             
            </div>
            <p>
                You can further test this in a new recording session by interacting with your app, idling for a few minutes and then stopping and examining once again. V8 runs a round of garbage collection when your application is <strong>idle</strong>(or if you’re just generating a lot of garbage). If it looks like the memory never really went down after your idle time, you’re creating a lot of garbage.
            </p>
            <p>
                A few cycles through garbage collection and ideally your memory profile should be <strong>flat.</strong> If it’s constantly going up in between GC cycles (and you see say, a step-function), then you may have a memory leak.
            </p>
            <div class="figure">
                <span id="reference-diagram" />
                    <div class="figure-contents">
                        <p>
                            <img alt="" class="aligncenter size-full wp-image-4976" src="images/ch05_sec02_Screen-Shot-2012-12-10-at-00_006.png" title="Screen Shot 2012-12-10 at 00.32.29" height="251" width="530">
                        </p>
                    </div>
             
            </div>
            <p>To the left of the Details view in Memory mode, you’ll notice three options: Document count, DOM node count and Event listener count.</p>
            <div class="figure">
                <span id="reference-diagram" />
                    <div class="figure-contents">
                        <p>
                             <img alt="" class="aligncenter size-full wp-image-4998" src="images/ch05_sec02_Screen-Shot-2012-12-10-at-11_004.png" title="Screen Shot 2012-12-10 at 11.00.29" height="131" width="220">
                        </p>
                    </div>
             
            </div>
            <p>The <strong>DOM node count</strong>graph shows the number of created DOM nodes still being held in memory (i.e which have yet to be garbage collected), whilst the other two options display the same for your <strong>event listeners</strong> and <strong>documents/iframe</strong>instances. Should you wish to only view counts for a particular counter type, you can deselect the others to hide them from the Details view.</p><p>We now know that there may be potential leaks, but we need to locate their origin. This is where we can use another feature called the<strong> Heap Profiler</strong>, found under the Profiles panel.</p>

        </div>

        <div class="sub_section">
             <h2>Fix</h2>
             <p>
                It’s very important to note that you should be sure of <strong>what </strong>is causing the bottleneck in your application before deciding on a Profile to use – for example, if you’re seeing a lot of yellow in your Timeline, chances are it’s a scripting issue and you should be using the JavaScript CPU Profile under Profiles. If it’s CSS selectors, use the CSS Selector profile.
             </p>

             <div class="figure">
                <span id="reference-diagram" />
                    <div class="figure-contents">
                         <p>

                            <img alt="" class="aligncenter size-full wp-image-5000" src="images/ch05_sec02_Screen-Shot-2012-12-10-at-11_003.png" title="Screen Shot 2012-12-10 at 11.03.21" height="60" width="395"></p><p>In our case we’re going to use the Heap Profiler as we care about <a href="https://developers.google.com/chrome-developer-tools/docs/memory-analysis-101">heap</a>, but the advice below should apply to the other profiles too.
                         </p>
                    </div>
             
            </div>

            <div class="figure">
                <span id="reference-diagram" />
                    <div class="figure-contents">
                        <p>
                            <img alt="" class="aligncenter size-full wp-image-4963" src="images/ch05_sec02_Screen-Shot-2012-12-10-at-00_008.png" title="Screen Shot 2012-12-10 at 00.14.32" height="284" width="530">
                        </p>
                    </div>
             
            </div>
            <p>
                The Profile’s <em>Take Heap Snapshot</em>option allows us to take a snapshot of the memory distribution of live JavaScript objects (and DOM nodes) in our application before and after the suspected bloat.</p><p>To use it, click ‘Start’ and repeat the actions you performed in the last step which you suspect (given the information you’ve discovered) may be causing leaks to create your first snapshot. Next click the record button ☻ to record a second snapshot, this time without interacting with the application at all.
            </p>
            <div class="figure">
                <span id="reference-diagram" />
                    <div class="figure-contents">
                        <p>
                            <img alt="" class="aligncenter size-full wp-image-5003" src="images/ch05_sec02_Screen-Shot-2012-12-10-at-11_002.png" title="Screen Shot 2012-12-10 at 11.10.57" height="135" width="491">
                        </p>
                    </div>
             
            </div>
            <p>We should now see at least two snapshots under the ‘Heap Snapshots’ category. Let’s compare them.</p>

            <div class="figure">
                <span id="reference-diagram" />
                    <div class="figure-contents">
                        <p>
                            <img alt="" class="aligncenter size-full wp-image-5005" src="images/ch05_sec02_Screen-Shot-2012-12-10-at-11_007.png" title="Screen Shot 2012-12-10 at 11.14.38" height="78" width="283">
                        </p>
                    </div>
             
            </div>
            <p>
                At the bottom of the DevTools window you will see a drop-down with the ‘Summary’ label on it. This allows you to switch between different views of the snapshots that are available. <em>Summary</em> view is great for detecting <strong>DOM leaks</strong> whilst <em>Comparison </em>view is useful for discovering the cause of <strong>memory leaks</strong>. Select <em>Comparison </em>and then click on ‘Snapshot 2’.
            </p>
            <div class="figure">
                <span id="reference-diagram" />
                    <div class="figure-contents">
                        <p>
                            <img alt="" class="aligncenter size-full wp-image-5004" src="images/ch05_sec02_Screen-Shot-2012-12-10-at-11_005.png" title="Screen Shot 2012-12-10 at 11.13.09" height="180" width="530">
                        </p>
                    </div>
             
            </div>

            <p>
                The information you now see are the objects that were created between profiles. The delta informs you if the memory deleted by the garbage collection process matches the memory used to create the object. Clicking on a particular constructor will display more details about it in&nbsp;<em>Object's remaining tree</em>&nbsp;view below the panel.
            </p>
            <div class="figure">
                <span id="reference-diagram" />
                    <div class="figure-contents">
                        <p>
                            <img alt="" class="aligncenter size-full wp-image-5016" src="images/ch05_sec02_Screen-Shot-2012-12-10-at-11_006.png" title="Screen Shot 2012-12-10 at 11.53.31" height="226" width="471">
                         </p>
                    </div>
             
            </div>
            <p>
                I know this probably looks a little scary, but bear with me. A typical scenario for where this view is useful is discovering whether references to elements you thought you had deleted and detached from the DOM are still hanging around. Once you have identified the code responsible for the leak, you can add the code necessary for cleaning the objects involved up after they are no longer required.</p><p>For example, in our application we noticed that there were still references to a detached HTMLImageElement hanging around. By clicking on the constructor and digging down, we were able to see that&nbsp;the Window (highlighted) was the one still holding on references to the image, so we knew to go looking for any event listeners we had working against the window object.
            </p>
            <div class="figure">
                <span id="reference-diagram" />
                    <div class="figure-contents">
                         <p>
                            <img alt="" class="aligncenter size-full wp-image-5006" src="images/ch05_sec02_Screen-Shot-2012-12-10-at-11.png" title="Screen Shot 2012-12-10 at 11.13.30" height="152" width="530">
                        </p>
                    </div>
             
            </div>
        </div>

        <div class="sub_section">
            <h2>Conclusions</h2>
            <p>
                Measuring and improving the performance of your applications <strong>properly</strong>will take time. There's unfortunately no silver bullet to this problem just yet, but the Timeline and Profiles in the DevTools can certainly help ease the process of discovering the major pain points. Do try out these tools to see if you find them helpful in your optimisation workflow.
            </p>
        </div>

    </body>
</html>
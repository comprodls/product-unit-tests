<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Writing Fast, Memory-Efficient JavaScript – Smashing Magazine</title>
        <link rel="stylesheet" type="text/css" href="css/core.css"/>
    </head>
    <body>
        <div class="chaptertitle">

            <h2 class="title">Writing Fast, Memory-Efficient JavaScript</h2>
        </div>
			<p>
				JavaScript engines such as Google’s <a class="ulink" href="http://code.google.com/p/v8/">V8</a> (Chrome, Node) are specifically designed for the <a class="ulink" href="http://www.html5rocks.com/en/tutorials/speed/v8/">fast execution</a>of large JavaScript applications. As you develop, if you care about memory usage and performance, you should be aware of some of what’s going on in your user’s browser’s JavaScript engine behind the scenes.
			</p>
			<p>
				Whether it’s V8, <a class="ulink" href="https://developer.mozilla.org/en-US/docs/SpiderMonkey">SpiderMonkey</a>(Firefox), <a class="ulink" href="http://my.opera.com/ODIN/blog/carakan-faq">Carakan</a> (Opera), <a class="ulink" href="http://en.wikipedia.org/wiki/Chakra_%28JScript_engine%29">Chakra</a> (IE) or something else, doing so can help you <strong>better optimize your applications</strong>. That’s not to say one should optimize for a single browser or engine. Never do that.
			</p>
			<p>You should, however, ask yourself questions such as:</p>
			<ul>
				<li>Is there anything I could be doing more efficiently in my code?</li>
				<li>What (common) optimizations do popular JavaScript engines make?</li>
				<li>What is the engine unable to optimize for, and is the garbage collector able to clean up what I’m expecting it to?</li>
			</ul>
			<p>
				<a style="border: 0px none;" class="ulink" href="http://dhybridcars.com/toyota-hybrid/2013-scion-fr-s-sexy-sport-car/media/2013-scion-fr-s-speed-gauge-img-8/"><div class="figure">
                <span id="constructorFunctions-diagram2" />
                <div class="figure-contents">
                   <img title="Dashboard Speedometer" src="images/ch05_sec01_fast_memory.jpg" alt="Dashboard Speedometer" height="330" width="500">
                </div>
            </div>
				</a><br>
			<em>Fast-loading Web sites — like fast cars — require the use specialized tools. Image source: <a class="ulink" href="http://dhybridcars.com/toyota-hybrid/2013-scion-fr-s-sexy-sport-car/media/2013-scion-fr-s-speed-gauge-img-8/">dHybridcars</a>.</em></p>
			<p>
				There are many common pitfalls when it comes to writing 
			memory-efficient and fast code, and in this article we’re going to 
			explore some test-proven approaches for writing code that performs 
			better.
		    </p>

        <div class="sub_section">
		   <h2>So, How Does JavaScript Work In V8? <a class="ulink" href="#so-how-does-javascript-work-in-v8" aria-label="Link to section 'So, How Does JavaScript Work In V8?'" class="sr hsl">Link</a></h2>

			<p>
				While it’s possible to develop large-scale applications without a 
			thorough understanding of JavaScript engines, any car owner will tell 
			you they’ve looked under the hood at least once. As Chrome is my browser
			 of choice, I’m going to talk a little about its JavaScript engine. V8 
			is made up of a few core pieces.
		    </p>
			<ul>
				<li>A <strong>base compiler</strong>, which parses your JavaScript and 
				generates native machine code before it is executed, rather than 
				executing bytecode or simply interpreting it. This code is initially not
				 highly optimized.</li>
				<li>V8 represents your objects in an <strong>object model</strong>. Objects are represented as associative arrays in JavaScript, but in V8 they are represented with <a class="ulink" href="https://developers.google.com/v8/design">hidden classes</a>, which are an internal type system for optimized lookups.</li>
				<li>The <strong>runtime profiler</strong> monitors the system being run and identifies “hot” functions (i.e. code that ends up spending a long time running).</li>
				<li>An <strong>optimizing compiler</strong> recompiles and optimizes the
				 “hot” code identified by the runtime profiler, and performs 
				optimizations such as inlining (i.e. replacing a function call site with
				 the body of the callee).</li>
				<li>V8 supports <strong>deoptimization</strong>, meaning the optimizing 
				compiler can bail out of code generated if it discovers that some of the
				 assumptions it made about the optimized code were too optimistic.</li>
				<li>It has a <strong>garbage collector</strong>. Understanding how it works can be just as important as the optimized JavaScript.</li>

		</div>
		<div class="sub_section">
			<h2>Garbage Collection <a class="ulink" href="#garbage-collection" aria-label="Link to section 'Garbage Collection'" class="sr hsl">Link</a></h2>
			<p>Garbage collection is <strong>a form of memory management</strong>. 
			It’s where we have the notion of a collector which attempts to reclaim 
			memory occupied by objects that are no longer being used. In a 
			garbage-collected language such as JavaScript, objects that are still 
			referenced by your application are not cleaned up.</p>
			<p>Manually de-referencing objects is not necessary in most cases. By 
			simply putting the variables where they need to be (ideally, as local as
			 possible, i.e. inside the function where they are used versus an outer 
			scope), things should just work.</p>
			<p><a style="border: 0px none;" class="ulink" href="http://www.flickr.com/photos/26817893@N05/2864644153/"><div class="figure">
                <span id="constructorFunctions-diagram2" />
                <div class="figure-contents">
                   <img title="Garbage Collection Attempts To Reclaim Memory" src="images/ch05_sec01_robot-cleaner.jpg" alt="Garbage collection attempts to reclaim memory." height="456" width="500">
                </div>
            </div></a><br>
			<em>Garbage collection attempts to reclaim memory. Image source: <a class="ulink" href="http://www.flickr.com/photos/26817893@N05/2864644153/">Valtteri Mäki</a>.</em></p>
			<p>It’s not possible to force garbage collection in JavaScript. You 
			wouldn’t want to do this, because the garbage collection process is 
			controlled by the runtime, and it generally knows best when things 
			should be cleaned up.</p>
			</ul>


			<h4>De-Referencing Misconceptions <a class="ulink" href="#de-referencing-misconceptions" aria-label="Link to section 'De-Referencing Misconceptions'" class="sr hsl">Link</a></h4>
			<p>In quite a few discussions online about reclaiming memory in JavaScript, the <code>delete</code>
			 keyword is brought up, as although it was supposed to be used for just 
			removing keys from a map, some developers think you can force 
			de-referencing using it. Avoid using <code>delete</code> if you can. In the below example, <code>delete o.x</code> does a lot more harm than good behind the scenes, as it changes <code>o</code>‘s hidden class and makes it a generic slow object.</p>
<pre class=" language-javascript"><code class=" language-javascript"><span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token punctuation">{</span> x<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span> 
delete o<span class="token punctuation">.</span>x<span class="token punctuation">;</span><span class="token comment" spellcheck="true"> // true 
</span>o<span class="token punctuation">.</span>x<span class="token punctuation">;</span><span class="token comment" spellcheck="true"> // undefined</span></code></pre>
			<p>That said, you are almost certain to find references to <code>delete</code>
			 in many popular JavaScript libraries – it does have a purpose in the 
			language. The main takeaway here is to avoid modifying the structure of 
			hot objects at runtime. JavaScript engines can detect such “hot” objects
			 and attempt to optimize them. This is easier if the object’s structure 
			doesn’t heavily change over its lifetime and <code>delete</code> can trigger such changes.</p>
			<p>There are also misconceptions about how <code>null</code> works. Setting an object reference to <code>null</code> doesn’t “null” the object. It sets the object reference to <code>null</code>. Using <code>o.x = null</code> is better than using <code>delete</code>, but it’s probably not even necessary.</p>
<pre class=" language-javascript"><code class=" language-javascript"><span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token punctuation">{</span> x<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span> 
o <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
o<span class="token punctuation">;</span><span class="token comment" spellcheck="true"> // null
</span>o<span class="token punctuation">.</span>x<span class="token comment" spellcheck="true"> // TypeError</span></code></pre>
			<p>If this reference was the last reference to the object, the object is
			 then eligible for garbage collection. If the reference was not the last
			 reference to the object, the object is reachable and will not be 
			garbage collected.</p>
			<p>Another important note to be aware of is that global variables are 
			not cleaned up by the garbage collector during the life of your page. 
			Regardless of how long the page is open, variables scoped to the 
			JavaScript runtime global object will stick around.</p>
<pre class=" language-javascript"><code class=" language-javascript"><span class="token keyword">var</span> myGlobalNamespace <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
			<p>Globals are cleaned up when you refresh the page, navigate to a 
			different page, close tabs or exit your browser. Function-scoped 
			variables get cleaned up when a variable falls out of scope. When 
			functions have exited and there aren’t any more references to it, the 
			variable gets cleaned up.</p>

			<h4>Rules of Thumb <a class="ulink"href="#rules-of-thumb" aria-label="Link to section 'Rules of Thumb'" class="sr hsl">Link</a></h4>
			<p>To give the garbage collector a chance to collect as many objects as possible as early as possible, <strong>don’t hold on to objects you no longer need</strong>. This mostly happens automatically; here are a few things to keep in mind.</p>
			<ul>
			<li>As mentioned earlier, a better alternative to manual de-referencing 
			is to use variables with an appropriate scope. I.e. instead of a global 
			variable that’s nulled out, just use a function-local variable that goes
			 out of scope when it’s no longer needed. This means cleaner code with 
			less to worry about.</li>
			<li>Ensure that you’re unbinding event listeners where they are no 
			longer required, especially when the DOM objects they’re bound to are 
			about to be removed</li>
			<li>If you’re using a data cache locally, make sure to clean that cache 
			or use an aging mechanism to avoid large chunks of data being stored 
			that you’re unlikely to reuse</li>
			</ul>

			<h4 id="functions">Functions <a class="ulink" href="#functions" aria-label="Link to section 'Functions'" class="sr hsl">Link</a></h4>
			<p>Next, let’s look at functions. As we’ve already said, garbage 
			collection works by reclaiming blocks of memory (objects) which are no 
			longer reachable. To better illustrate this, here are some examples.</p>
<pre class=" language-javascript"><code class=" language-javascript"><span class="token keyword">function</span> <span class="token function">foo<span class="token punctuation">(</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> bar <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LargeObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bar<span class="token punctuation">.</span><span class="token function">someCall<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
			<p>When <code>foo</code> returns, the object which <code>bar</code> points to is automatically available for garbage collection, because there is nothing left that has a reference to it.</p>
			<p>Compare this to:</p>
<pre class=" language-javascript"><code class=" language-javascript"><span class="token keyword">function</span> <span class="token function">foo<span class="token punctuation">(</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> bar <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LargeObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bar<span class="token punctuation">.</span><span class="token function">someCall<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> bar<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">
// somewhere else
</span><span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token function">foo<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
			<p>We now have a reference to the object which survives the call and persists until the caller assigns something else to <code>b</code> (or <code>b</code> goes out of scope).</p>


			<h4 id="closures">Closures <a class="ulink" href="#closures" aria-label="Link to section 'Closures'" class="sr hsl">Link</a></h4>
			<p>When you see a function that returns an inner function, that inner 
			function will have access to the outer scope even after the outer 
			function is executed. This is basically a <a class="ulink" href="http://robertnyman.com/2008/10/09/explaining-javascript-scope-and-closures/">closure</a> — an expression which can work with variables set within a specific context. For example:</p>
<pre class=" language-javascript"><code class=" language-javascript"><span class="token keyword">function</span> sum <span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token function">sumIt<span class="token punctuation">(</span></span>y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> x <span class="token operator">+</span> y<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> sumIt<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">
// Usage
</span><span class="token keyword">var</span> sumA <span class="token operator">=</span> <span class="token function">sum<span class="token punctuation">(</span></span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> sumB <span class="token operator">=</span> <span class="token function">sumA<span class="token punctuation">(</span></span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log<span class="token punctuation">(</span></span>sumB<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true"> // Returns 7</span></code></pre>

			<p>The function object created within the execution context of the call to <code>sum</code>
			 can’t be garbage collected, as it’s referenced by a global variable and
			 is still very much accessible. It can still be executed via <code>sumA(n)</code>.</p>
			<p>Let’s look at another example. Here, can we access <code>largeStr</code>?</p>
<pre class=" language-javascript"><code class=" language-javascript"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> largeStr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join<span class="token punctuation">(</span></span><span class="token string">'x'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> largeStr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>Yes, we can, via <code>a()</code>, so it’s not collected. How about this one?</p>
<pre class=" language-javascript"><code class=" language-javascript"><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> smallStr <span class="token operator">=</span> <span class="token string">'x'</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> largeStr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join<span class="token punctuation">(</span></span><span class="token string">'x'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> smallStr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

			<p>We can’t access it anymore and it’s a candidate for garbage collection.</p>

			<h4 id="timers">Timers <a class="ulink" href="#timers" aria-label="Link to section 'Timers'" class="sr hsl">Link</a></h4>
			<p>One of the worst places to leak is in a loop, or in <code>setTimeout()</code>/<code>setInterval()</code>, but this is quite common.</p>
			<p>Consider the following example.</p>
<pre class=" language-javascript"><code class=" language-javascript"><span class="token keyword">var</span> myObj <span class="token operator">=</span> <span class="token punctuation">{</span>
    callMeMaybe<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> myRef <span class="token operator">=</span> this<span class="token punctuation">;</span>
        <span class="token keyword">var</span> val <span class="token operator">=</span> <span class="token function">setTimeout<span class="token punctuation">(</span></span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            console<span class="token punctuation">.</span><span class="token function">log<span class="token punctuation">(</span></span><span class="token string">'Time is running out!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            myRef<span class="token punctuation">.</span><span class="token function">callMeMaybe<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>

			<p>If we then run:</p>

<pre class=" language-javascript"><code class=" language-javascript">myObj<span class="token punctuation">.</span><span class="token function">callMeMaybe<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
			<p>to begin the timer, we can see every second “Time is running out!” If we then run:</p>
<pre class=" language-javascript"><code class=" language-javascript">myObj <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></code></pre>
			<p>The timer will still fire. <code>myObj</code> won’t be garbage collected as the closure passed to <code>setTimeout</code> has to be kept alive in order to be executed. In turn, it holds references to <code>myObj</code> as it captures <code>myRef</code>. This would be the same if we’d passed the closure to any other function, keeping references to it.</p>
			<p>It is also worth keeping in mind that references inside a <code>setTimeout</code>/<code>setInterval</code> call, such as functions, will need to execute and complete before they can be garbage collected.</p>


        </div>
        <div class="sub_section">

			<h2>Be Aware Of Performance Traps <a class="ulink" href="#be-aware-of-performance-traps" aria-label="Link to section 'Be Aware Of Performance Traps'" class="sr hsl">Link</a></h2>
			<p>It’s important never to optimize code until you actually need to. 
			This can’t be stressed enough. It’s easy to see a number of 
			micro-benchmarks showing that N is more optimal than M in V8, but test 
			it in a real module of code or in an actual application, and <strong>the true impact of those optimizations may be much more minimal</strong> than you were expecting.</p>
			<p><a style="border: 0px none;" class="ulink" href="http://www.flickr.com/photos/tim_uk/7717078488/sizes/c/in/photostream/"><div class="figure">
                <span id="constructorFunctions-diagram2" />
                <div class="figure-contents">
                    <img title="Speed Trap" src="images/ch05_sec01_speed-trap.jpg" alt="Speed trap." height="350" width="500">
                </div>
            </div></a><br>
			<em>Doing too much can be as harmful as not doing anything. Image source: <a class="ulink" href="http://www.flickr.com/photos/tim_uk/7717078488/sizes/c/in/photostream/">Tim Sheerman-Chase</a>.</em></p>
			<p>Let’s say we want to create a module which:</p>
			<ul>
				<li>Takes a local source of data containing items with a numeric ID,</li>
				<li>Draws a table containing this data,</li>
				<li>Adds event handlers for toggling a class when a user clicks on any cell.</li>
			</ul>
			<p>There are a few different factors to this problem, even though it’s 
			quite straightforward to solve. How do we store the data? How do we 
			efficiently draw the table and append it to the DOM? How do we handle 
			events on this table optimally?</p>
			<p>A first (naive) take on this problem might be to store each piece of 
			available data in an object which we group into an array. One might use 
			jQuery to iterate through the data and draw the table, then append it to
			 the DOM. Finally, one might use event binding for adding the click 
			behavior we desire.</p>
			<p><strong>Note: This is NOT what you should be doing</strong></p>
<pre class=" language-javascript"><code class=" language-javascript"><span class="token keyword">var</span> moduleA <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>

        data<span class="token punctuation">:</span> dataArrayObject<span class="token punctuation">,</span>

        init<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            this<span class="token punctuation">.</span><span class="token function">addTable<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            this<span class="token punctuation">.</span><span class="token function">addEvents<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>

        addTable<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> rows<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                $tr <span class="token operator">=</span> $<span class="token punctuation">(</span><span class="token string">'&lt;tr&gt;&lt;/tr&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> this<span class="token punctuation">.</span>data<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    $tr<span class="token punctuation">.</span><span class="token function">append<span class="token punctuation">(</span></span><span class="token string">'&lt;td&gt;'</span> <span class="token operator">+</span> this<span class="token punctuation">.</span>data<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'id'</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">'&lt;/td&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                $tr<span class="token punctuation">.</span><span class="token function">appendTo<span class="token punctuation">(</span></span>$tbody<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        addEvents<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            $<span class="token punctuation">(</span><span class="token string">'table td'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on<span class="token punctuation">(</span></span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                $<span class="token punctuation">(</span>this<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toggleClass<span class="token punctuation">(</span></span><span class="token string">'active'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
			<p>Simple, but it gets the job done.</p>
			<p>In this case however, the only data we’re iterating are IDs, a 
			numeric property which could be more simply represented in a standard 
			array. Interestingly, directly using <code>DocumentFragment</code> and 
			native DOM methods are more optimal than using jQuery (in this manner) 
			for our table generation, and of course, event delegation is typically 
			more performant than binding each <code>td</code> individually. </p>
			<p>Note that jQuery does use <code>DocumentFragment</code> internally behind the scenes, but in our example, the code is calling <code>append()</code>
			 within a loop and each of these calls has little knowledge of the other
			 so it may not be able to optimize for this example. This should 
			hopefully not be a pain point, but be sure to benchmark your own code to
			 be sure.</p>

			<p>In our case, adding in these changes results in some good (expected) 
			performance gains. Event delegation provides decent improvement over 
			simply binding, and <a class="ulink"  href="http://jsperf.com/first-pass">opting for <code>documentFragment</code></a> was a real booster.</p>
<pre class=" language-javascript"><code class=" language-javascript"><span class="token keyword">var</span> moduleD <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">return</span> <span class="token punctuation">{</span>

        data<span class="token punctuation">:</span> dataArray<span class="token punctuation">,</span>

        init<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            this<span class="token punctuation">.</span><span class="token function">addTable<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            this<span class="token punctuation">.</span><span class="token function">addEvents<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        addTable<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> td<span class="token punctuation">,</span> tr<span class="token punctuation">;</span>
            <span class="token keyword">var</span> frag <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createDocumentFragment<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> frag2 <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createDocumentFragment<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> rows<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                tr <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement<span class="token punctuation">(</span></span><span class="token string">'tr'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> this<span class="token punctuation">.</span>data<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    td <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement<span class="token punctuation">(</span></span><span class="token string">'td'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    td<span class="token punctuation">.</span><span class="token function">appendChild<span class="token punctuation">(</span></span>document<span class="token punctuation">.</span><span class="token function">createTextNode<span class="token punctuation">(</span></span>this<span class="token punctuation">.</span>data<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    frag2<span class="token punctuation">.</span><span class="token function">appendChild<span class="token punctuation">(</span></span>td<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                tr<span class="token punctuation">.</span><span class="token function">appendChild<span class="token punctuation">(</span></span>frag2<span class="token punctuation">)</span><span class="token punctuation">;</span>
                frag<span class="token punctuation">.</span><span class="token function">appendChild<span class="token punctuation">(</span></span>tr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            tbody<span class="token punctuation">.</span><span class="token function">appendChild<span class="token punctuation">(</span></span>frag<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        addEvents<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            $<span class="token punctuation">(</span><span class="token string">'table'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on<span class="token punctuation">(</span></span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token string">'td'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                $<span class="token punctuation">(</span>this<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toggleClass<span class="token punctuation">(</span></span><span class="token string">'active'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
			<p>We might then look to other ways of improving performance. You may 
			have read somewhere that using the prototypal pattern is more optimal 
			than the module pattern (we confirmed it wasn’t earlier), or heard that 
			using JavaScript templating frameworks are highly optimized. Sometimes 
			they are, but use them because they make for readable code. Also, 
			precompile!. Let’s test and find out how true this hold in practice.</p>
<pre class=" language-javascript"><code class=" language-javascript">moduleG <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

moduleG<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>data <span class="token operator">=</span> dataArray<span class="token punctuation">;</span>
moduleG<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>init <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    this<span class="token punctuation">.</span><span class="token function">addTable<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    this<span class="token punctuation">.</span><span class="token function">addEvents<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
moduleG<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>addTable <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> template <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">template<span class="token punctuation">(</span></span>$<span class="token punctuation">(</span><span class="token string">'#template'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">text<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> html <span class="token operator">=</span> <span class="token function">template<span class="token punctuation">(</span></span><span class="token punctuation">{</span><span class="token string">'data'</span> <span class="token punctuation">:</span> this<span class="token punctuation">.</span>data<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    $tbody<span class="token punctuation">.</span><span class="token function">append<span class="token punctuation">(</span></span>html<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
moduleG<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>addEvents <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   $<span class="token punctuation">(</span><span class="token string">'table'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on<span class="token punctuation">(</span></span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token string">'td'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       $<span class="token punctuation">(</span>this<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toggleClass<span class="token punctuation">(</span></span><span class="token string">'active'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> modG <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">moduleG</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
			<p>As it turns out, in this case the performance benefits are negligible. <a class="ulink"  href="http://jsperf.com/second-pass">Opting for templating and prototypes</a>
			 didn’t really offer anything more than what we had before. That said, 
			performance isn’t really the reason modern developers use either of 
			these things — it’s the readability, inheritance model and 
			maintainability they bring to your codebase.</p>
			<p>More complex problems include <a class="ulink" href="http://jsperf.com/canvas-drawimage-vs-webgl-drawarrays/6">efficiently drawing images using canvas</a> and <a class="ulink" href="http://jsperf.com/canvas-pixel-manipulation/30">manipulating pixel data</a> with or without <a class="ulink" href="http://jsperf.com/typed-arrays-for-pixel-manipulation">typed arrays</a></p>
			<p>Always give micro-benchmarks a close lookover before exploring their use in your application. Some of you may recall the <a class="ulink" href="http://jsperf.com/dom-vs-innerhtml-based-templating/473">JavaScript templating shoot-off</a> and the <a class="ulink"  href="http://jsperf.com/javascript-templating-shootoff-extended/26">extended shoot-off that followed</a>.
			 You want to make sure that tests aren’t being impacted by constraints 
			you’re unlikely to see in real world applications — test optimizations 
			together in actual code.</p>
		</div>
		<div class="sub_section">
			<h2 >V8 Optimization Tips <a class="ulink" href="#v8-optimization-tips" aria-label="Link to section 'V8 Optimization Tips'" class="sr hsl">Link</a></h2>
			<p>Whilst detailing every V8 optimization is outside the scope of this 
			article, there are certainly many tips worth noting. Keep these in mind 
			and you’ll reduce your chances of writing unperformant code.</p>
			<ul>
			<li>Certain patterns will cause V8 to bail out of optimizations. A 
			try-catch, for example, will cause such a bailout. For more information 
			on what functions can and can’t be optimized, you can use <code>--trace-opt file.js</code> with the d8 shell utility that comes with V8.</li>
			<li>If you care about speed, try very hard to keep your functions 
			monomorphic, i.e. make sure that variables (including properties, arrays
			 and function parameters) only ever contain objects with the same hidden
			 class. For example, don’t do this:</li>
			</ul>
<pre class=" language-javascript"><code class=" language-javascript"><span class="token keyword">function</span> <span class="token function">add<span class="token punctuation">(</span></span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
   <span class="token keyword">return</span> x<span class="token operator">+</span>y<span class="token punctuation">;</span>
<span class="token punctuation">}</span> 

<span class="token function">add<span class="token punctuation">(</span></span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token function">add<span class="token punctuation">(</span></span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token function">add<span class="token punctuation">(</span></span>my_custom_object<span class="token punctuation">,</span> undefined<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
			<ul>
				<li>Don’t load from uninitialized or deleted elements. This won’t make a difference in output, but it will make things slower.</li>
				<li>Don’t write enormous functions, as they are more difficult to optimize</li>
			</ul>
			<p>For more tips, watch Daniel Clifford’s Google I/O talk <a class="ulink" href="http://www.youtube.com/watch?v=UJPdhx5zTaw">Breaking the JavaScript Speed Limit with V8</a>as it covers these topics well. <a class="ulink"href="http://floitsch.blogspot.co.uk/2012/03/optimizing-for-v8-introduction.html">Optimizing For V8 — A Series</a> is also worth a read.</p>

            <h4>Objects Vs. Arrays: Which Should I Use? <a class="ulink" href="#objects-vs-arrays-which-should-i-use" aria-label="Link to section 'Objects Vs. Arrays: Which Should I Use?'" class="sr hsl">Link</a></h4>
			<ul>
				<li>If you want to store a bunch of numbers, or a list of objects of the same type, use an array.</li>
				<li>If what you semantically need is an object with a bunch of 
				properties (of varying types), use an object with properties. That’s 
				pretty efficient in terms of memory, and it’s also pretty fast.</li>
				<li>Integer-indexed elements, regardless of whether they’re stored in an array or an object, are <a class="ulink"  href="http://jsperf.com/performance-of-array-vs-object/3">much faster to iterate over than object properties</a>.</li>
				<li>Properties on objects are quite complex: they can be created with 
				setters, and with differing enumerability and writability. Items in 
				arrays aren’t able to be customized as heavily — they either exist or 
				they don’t. At an engine level, this allows for more optimization in 
				terms of organizing the memory representing the structure. This is 
				particularly beneficial when the array contains numbers. For example, 
				when you need vectors, don’t define a class with properties x, y, z; use
				 an array instead..</li>
			</ul>
			<p>There’s really only one major difference between objects and arrays in JavaScript, and that’s the arrays’ magic <code>length</code> property. If you’re keeping track of this property yourself, objects in V8 should be just as fast as arrays.</p>

			<h4>Tips When Using Objects <a class="ulink" href="#tips-when-using-objects" aria-label="Link to section 'Tips When Using Objects'" class="sr hsl">Link</a></h4>
			<ul>
			<li>Create objects using a constructor function. This ensures that all 
			objects created with it have the same hidden class and helps avoid 
			changing these classes. As an added benefit, it’s also <a class="ulink"href="http://jsperf.com/object-create-vs-constructor-vs-object-literal/7">slightly faster than <code>Object.create()</code></a></li>
			<li>There are no restrictions on the number of different object types 
			you can use in your application or on their complexity (within reason: 
			long prototype chains tend to hurt, and objects with only a handful of 
			properties get a special representation that’s a bit faster than bigger 
			objects). For “hot” objects, try to keep the prototype chains short and 
			the field count low.</li>
			</ul>
			<p><strong>Object Cloning</strong><br>
			Object cloning is a common problem for app developers. While it’s 
			possible to benchmark how well various implementations work with this 
			type of problem in V8, be very careful when copying anything. Copying 
			big things is generally slow — don’t do it. <code>for..in</code> loops 
			in JavaScript are particularly bad for this, as they have a devilish 
			specification and will likely never be fast in any engine for arbitrary 
			objects.</p>
			<p>When you absolutely do need to copy objects in a performance-critical
			 code path (and you can’t get out of this situation), use an array or a 
			custom “copy constructor” function which copies each property 
			explicitly. This is probably the fastest way to do it:</p>
<pre class=" language-javascript"><code class=" language-javascript"><span class="token keyword">function</span> <span class="token function">clone<span class="token punctuation">(</span></span>original<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  this<span class="token punctuation">.</span>foo <span class="token operator">=</span> original<span class="token punctuation">.</span>foo<span class="token punctuation">;</span>
  this<span class="token punctuation">.</span>bar <span class="token operator">=</span> original<span class="token punctuation">.</span>bar<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> copy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">clone</span><span class="token punctuation">(</span>original<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
			<p><strong>Cached Functions in the Module Pattern</strong><br>
			Caching your functions when using the module pattern can lead to 
			performance improvements. See below for an example where the variation 
			you’re probably used to seeing is slower as it forces new copies of the 
			member functions to be created all the time.</p>
			<p>
				<div class="figure">
                <span id="constructorFunctions-diagram2" />
                <div class="figure-contents">
                    <img title="Performance Improvements When Using The Module And Prototypal Patterns" src="images/ch05_sec01_Screen-Shot-2012-11-06-at-10.42.10.png" alt="Performance improvements" height="253" width="500">
                </div>
            </div>
            <br>
			<em>Performance improvements when using the module or prototypal patterns.</em></p>
			<p>Here is a <a class="ulink" href="http://jsperf.com/prototypal-performance/12">test of prototype versus module pattern performance</a></p>
<pre class=" language-javascript"><code class=" language-javascript"><span class="token comment" spellcheck="true">// Prototypal pattern
</span>  Klass1 <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  Klass1<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">log<span class="token punctuation">(</span></span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  Klass1<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>bar <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">log<span class="token punctuation">(</span></span><span class="token string">'bar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">  // Module pattern
</span>  Klass2 <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> foo <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">log<span class="token punctuation">(</span></span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      bar <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">log<span class="token punctuation">(</span></span><span class="token string">'bar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> <span class="token punctuation">{</span>
          foo<span class="token punctuation">:</span> foo<span class="token punctuation">,</span>
          bar<span class="token punctuation">:</span> bar
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>


<span class="token comment" spellcheck="true">  // Module pattern with cached functions
</span>  <span class="token keyword">var</span> FooFunction <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">log<span class="token punctuation">(</span></span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> BarFunction <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">log<span class="token punctuation">(</span></span><span class="token string">'bar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  Klass3 <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
          foo<span class="token punctuation">:</span> FooFunction<span class="token punctuation">,</span>
          bar<span class="token punctuation">:</span> BarFunction
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>


<span class="token comment" spellcheck="true">  // Iteration tests
</span>
<span class="token comment" spellcheck="true">  // Prototypal
</span>  <span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">,</span>
      objs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Klass1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      objs<span class="token punctuation">.</span><span class="token function">push<span class="token punctuation">(</span></span><span class="token keyword">new</span> <span class="token class-name">Klass1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      o<span class="token punctuation">.</span>bar<span class="token punctuation">;</span>
      o<span class="token punctuation">.</span>foo<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">  // Module pattern
</span>  <span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">,</span>
      objs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token function">Klass2<span class="token punctuation">(</span></span><span class="token punctuation">)</span>
      objs<span class="token punctuation">.</span><span class="token function">push<span class="token punctuation">(</span></span><span class="token function">Klass2<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      o<span class="token punctuation">.</span>bar<span class="token punctuation">;</span>
      o<span class="token punctuation">.</span>foo<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">  // Module pattern with cached functions
</span>  <span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">,</span>
      objs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token function">Klass3<span class="token punctuation">(</span></span><span class="token punctuation">)</span>
      objs<span class="token punctuation">.</span><span class="token function">push<span class="token punctuation">(</span></span><span class="token function">Klass3<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      o<span class="token punctuation">.</span>bar<span class="token punctuation">;</span>
      o<span class="token punctuation">.</span>foo<span class="token punctuation">;</span>
  <span class="token comment" spellcheck="true">}
// See the test for full details</span></code></pre>
			<p><strong>Note:</strong> If you don’t require a class, avoid the 
			trouble of creating one. Here’s an example of how to gain performance 

			boosts by remoxing the class overhead altogether <a class="ulink"  href="http://jsperf.com/prototypal-performance/54">http://jsperf.com/prototypal-performance/54</a>.</p>

			<h4>Tips When Using Arrays <a class="ulink"  href="#tips-when-using-arrays" aria-label="Link to section 'Tips When Using Arrays'" class="sr hsl">Link</a></h4>
			<p>Next let’s look at a few tips for arrays. In general, <strong>don’t delete array elements</strong>.
			 It would make the array transition to a slower internal representation.
			 When the key set becomes sparse, V8 will eventually switch elements to 
			dictionary mode, which is even slower.</p>
			<p><strong>Array Literals</strong><br>
			Array literals are useful because they give a hint to the VM about the 
			size and type of the array. They’re typically good for small to medium 
			sized arrays.</p>
<pre class=" language-javascript"><code class=" language-javascript"><span class="token comment" spellcheck="true">// Here V8 can see that you want a 4-element array containing numbers:
</span><span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">

// Don't do this:
</span>a <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token comment" spellcheck="true">; // Here V8 knows nothing about the array
</span><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span><span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     a<span class="token punctuation">.</span><span class="token function">push<span class="token punctuation">(</span></span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
			<p><strong>Storage of Single Types Vs. Mixed Types</strong><br>
			It’s never a good idea to mix values of different types (e.g. numbers, 
			strings, undefined or true/false) in the same array (i.e. <code>var arr = [1, “1”, undefined, true, “true”]</code>)</p>
			<p><a class="ulink"  href="http://jsperf.com/type-inference-performance/2">Test of type inference performance</a></p>
			<p>As we can see from the results, the array of <code>ints</code> is the fastest.</p>
			<p><strong>Sparse Arrays vs. Full Arrays</strong><br>
			When you use sparse arrays, be aware that accessing elements in them is 
			much slower than in full arrays. That’s because V8 doesn’t allocate a 
			flat backing store for the elements if only a few of them are used. 
			Instead, it manages them in a dictionary, which saves space, but costs 
			time on access.</p>
			<p><a class="ulink" href="http://jsperf.com/sparse-arrays-vs-full-arrays">Test of sparse arrays versus full arrays</a>.</p>
			<p>The full array <code>sum</code> and <code>sum</code> of all elements 
			on an array without zeros were actually the fastest. Whether the full 
			array contains zeroes or not should not make a difference.</p>
			<p><strong>Packed Vs. Holey Arrays</strong><br>
			Avoid “holes” in an array (created by deleting elements or <code>a[x] = foo</code> with <code>x &gt; a.length</code>). Even if only a single element is deleted from an otherwise “full” array, things will be much slower.</p>
			<p><a class="ulink" href="http://jsperf.com/packed-vs-holey-arrays">Test of packed versus holey arrays</a>.</p>
			<p><strong>Pre-allocating Arrays Vs. Growing As You Go</strong><br>
			Don’t pre-allocate large arrays (i.e. greater than 64K elements) to 
			their maximum size, instead grow as you go. Before we get to the 
			performance tests for this tip, keep in mind that this is specific to 
			only some JavaScript engines.</p>
			<p><div class="figure">
                <span id="constructorFunctions-diagram2" />
                <div class="figure-contents">
                  <img title="Empty Literal VS. Pre-Allocated Array In Various Browsers" src="images/ch05_sec01_graph2.jpg" alt="Test of empty literal versus pre-allocated arrays in various browsers." height="323" width="500">
                </div>
            </div><br>
			<em>Test of empty literal versus pre-allocated array in various browsers.</em></p>
			<p>Nitro (Safari) actually treats pre-allocated arrays more favorably. 
			However, in other engines (V8, SpiderMonkey), not pre-allocating is more
			 efficient.</p>
			<p><a class="ulink" href="http://jsperf.com/pre-allocated-arrays">Test of pre-allocated arrays</a>.</p>
<pre class=" language-javascript"><code class=" language-javascript"><span class="token comment" spellcheck="true">// Empty array
</span><span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token comment" spellcheck="true">

// Pre-allocated array
</span><span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">1000000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>


        </div>
        <div class="sub_section">

			<h2>Optimizing Your Application <a class="ulink" href="#optimizing-your-application" aria-label="Link to section 'Optimizing Your Application'" class="sr hsl">Link</a></h2>
			<p>In the world of Web applications, <strong>speed is everything</strong>.
			 No user wants a spreadsheet application to take seconds to sum up an 
			entire column or a summary of their messages to take a minute before 
			it’s ready. This is why squeezing every drop of extra performance you 
			can out of code can sometimes be critical.</p>
			<p><a style="border: 0px none;" class="ulink" href="http://www.flickr.com/photos/perolofforsberg/6691744587/in/photostream/">
				<div class="figure">
                <span id="constructorFunctions-diagram2" />
                <div class="figure-contents">
                    <img title="Old Phone On iPad Screen" src="images/ch05_sec01_improving-apps.jpg" alt="An old phone on the screen of an iPad." height="375" width="500">
                </div>
            </div>
        	</a><br>
			<em>Image source: <a class="ulink" href="http://www.flickr.com/photos/perolofforsberg/6691744587/in/photostream/">Per Olof Forsberg</a>.</em></p>
			<p>While understanding and improving your application performance is 
			useful, it can also be difficult. We recommend the following steps to 
			fix performance pain points:</p>
			<ul>
			<li>Measure it: Find the slow spots in your application (~45%)</li>
			<li>Understand it: Find out what the actual problem is (~45%)</li>
			<li>Fix it! (~10%)</li>
			</ul>
			<p>Some of the tools and techniques recommended below can assist with this process.</p>


			<h4>Benchmarking <a class="ulink" href="#benchmarking" aria-label="Link to section 'Benchmarking'" class="sr hsl">Link</a></h4>
			<p>There are many ways to run benchmarks on JavaScript snippets to test 
			their performance — the general assumption being that benchmarking is 
			simply comparing two timestamps. One such pattern was pointed out by the
			 <a class="ulink" href="http://jsperf.com/">jsPerf</a> team, and happens to be used in <a class="ulink" href="http://www.webkit.org/perf/sunspider/sunspider.html">SunSpider</a>‘s and <a class="ulink" href="http://krakenbenchmark.mozilla.org/">Kraken</a><sup class="po" id="note-35">‘s benchmark suites:</p>
<pre class=" language-javascript"><code class=" language-javascript"><span class="token keyword">var</span> totalTime<span class="token punctuation">,</span>
    start <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">,</span>
    iterations <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>iterations<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment" spellcheck="true"> // Code snippet goes here
</span><span class="token punctuation">}</span><span class="token comment" spellcheck="true">
// totalTime → the number of milliseconds taken 
</span><span class="token comment" spellcheck="true">// to execute the code snippet 1000 times
</span>totalTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span> <span class="token operator">-</span> start<span class="token punctuation">;</span></code></pre>
			<p>Here, the code to be tested is placed within a loop and run a set 
			number of times (e.g. six). After this, the start date is subtracted 
			from the end date to find the time taken to perform the operations in 
			the loop.</p>
			<p>However, this oversimplifies how benchmarking should be done, 
			especially if you want to run the benchmarks in multiple browsers and 
			environments. Garbage collection itself can have an impact on your 
			results. Even if you’re using a solution like <code>window.performance</code>, you still have to account for these pitfalls.</p>
			<p>Regardless of whether you are simply running benchmarks against parts
			 of your code, writing a test suite or coding a benchmarking library, 
			there’s a lot more to JavaScript benchmarking than you might think. For a
			 more detailed guide to benchmarking, I highly recommend reading <a class="ulink" href="http://mathiasbynens.be/notes/javascript-benchmarking">JavaScript Benchmarking</a> by Mathias Bynens and John-David Dalton.</p>

			 <h4 id="profiling">Profiling <a class="ulink" href="#profiling" aria-label="Link to section 'Profiling'" class="sr hsl">Link</a></h4>
			<p>The Chrome Developer Tools have good support for <a class="ulink" href="https://developers.google.com/chrome-developer-tools/docs/profiles">JavaScript profiling</a>.
			 You can use this feature to detect what functions are eating up the 
			most of your time so that you can then go optimize them. This is 
			important, as even small changes to your codebase can have serious 
			impacts on your overall performance.</p>
			<p><div class="figure">
                <span id="constructorFunctions-diagram2" />
                <div class="figure-contents">
                   <img title="Profiles Panel In Chrome Developer Tools" src="images/ch05_sec01_profiling.jpg" alt="Profiles panel in Chrome Developer Tools." height="315" width="500">
                </div>
            </div><br>
			<em>Profiles Panel in Chrome Developer Tools.</em></p>
			<p>Profiling starts with obtaining a baseline for your code’s current 
			performance, which can be discovered using the Timeline. This will tell 
			us how long our code took to run. The Profiles tab then gives us a 
			better view into what’s happening in our application. The JavaScript CPU
			 profile shows us how much CPU time is being used by our code, the CSS 
			selector profile shows us how much time is spent processing selectors 
			and Heap snapshots show how much memory is being used by our objects.</p>
			<p>Using these tools, we can isolate, tweak and reprofile to gauge 
			whether changes we’re making to specific functions or operations are 
			improving performance.</p>
			<p><div class="figure">
                <span id="constructorFunctions-diagram2" />
                <div class="figure-contents">
                    <img title="The Profile Tab Gives Information About Your Code's Performance" src="images/ch05_sec01_profiling2.jpg" alt="The profile tab gives information about your code's performance." height="293" width="500">
                </div>
            </div><br>
			<em>The Profile tab gives you information about your code’s performance.</em></p>
			<p>For a good introduction to profiling, read <a class="ulink" href="http://www.smashingmagazine.com/2012/06/12/javascript-profiling-chrome-developer-tools/">JavaScript Profiling With The Chrome Developer Tools</a>, by Zack Grossbart.</p>
			<p>Tip: Ideally, you want to ensure that your profiling isn’t being 
			affected by extensions or applications you’ve installed, so run Chrome 
			using the <code>--user-data-dir &lt;empty_directory&gt;</code> flag. 
			Most of the time, this approach to optimization testing should be 
			enough, but there are times when you need more. This is where V8 flags 
			can be of help.</p>


			<h4>Avoiding Memory Leaks — Three Snapshot Techniques for Discovery <a class="ulink" href="#avoiding-memory-leaks-three-snapshot-techniques-for-discovery" aria-label="Link to section 'Avoiding Memory Leaks — Three Snapshot Techniques for Discovery'" class="sr hsl">Link</a></h4>
			<p>Internally at Google, the Chrome Developer Tools are heavily used by 
			teams such as Gmail to help us discover and squash memory leaks.</p>
			<p><div class="figure">
                <span id="constructorFunctions-diagram2" />
                <div class="figure-contents">
                    <img title="Memory Statistics In Chrome Developer Tools" src="images/ch05_sec01_devtools.jpg" alt="Memory statistics in Chrome Developer Tools." height="283" width="500">
                </div>
            </div><br>
			<em>Memory statistics in Chrome Developer Tools.</em></p>
			<p>Some of the memory statistics that our teams care about include 
			private memory usage, JavaScript heap size, DOM node counts, storage 
			clearing, event listener counts and what’s going on with garbage 
			collection. For those familiar with event-driven architectures, you 
			might be interested to know that one of the most common issues we used 
			to have were <code>listen()</code>’s without <code>unlisten()</code>’s (Closure) and missing <code>dispose()</code>’s for objects that create event listeners.</p>
			<p>Luckily the DevTools can help locate some of these issues, and 
			Loreena Lee has a fantastic presentation available documenting the <a class="ulink" href="https://docs.google.com/presentation/d/1wUVmf78gG-ra5aOxvTfYdiLkdGaR9OhXRnOlIcEmu2s/pub?start=false&amp;loop=false&amp;delayms=3000#slide=id.g1d65bdf6_0_0">“3 snapshot” technique</a> for finding leaks within the DevTools that I can’t recommend reading through enough.</p>
			<p>The gist of the technique is that you record a number of actions in 
			your application, force a garbage collection, check if the number of DOM
			 nodes doesn’t return to your expected baseline and then analyze three 
			heap snapshots to determine if you have a leak.</p>

			<h4>Memory Management in Single-Page Applications <a class="ulink" href="#memory-management-in-single-page-applications" aria-label="Link to section 'Memory Management in Single-Page Applications'" class="sr hsl">Link</a></h4>
			<p>Memory management is quite important when writing modern single-page 
			applications (e.g. AngularJS, Backbone, Ember) as they almost never get 
			refreshed. This means that memory leaks can become apparent quite 
			quickly. This is a huge trap on mobile single-page applications, because
			 of limited memory, and on long-running applications like email clients 
			or social networking applications. <strong>With great power comes great responsibility.</strong></p>
			<p>There are various ways to prevent this. In Backbone, ensure you always dispose old views and references using <code>dispose()</code> (currently available in <a class="ulink" href="https://github.com/documentcloud/backbone/blob/master/backbone.js#L1234">Backbone (edge)</a>).
			 This function was recently added, and removes any handlers added in the
			 view’s ‘events’ object, as well as any collection or model listeners 
			where the view is passed as the third argument (callback context). <code>dispose()</code> is also called by the view’s <code>remove()</code>, taking care of the majority of basic memory cleanup needs when the element is <a class="ulink" href="https://github.com/documentcloud/backbone/blob/master/backbone.js#L1235">cleared from the screen</a>. Other libraries like Ember <a class="ulink" href="https://github.com/emberjs/ember.js/blob/d8f76a7fdde741ae3d1e07b12df9cb6718170e48/packages/ember-handlebars/lib/helpers/binding.js#L296">clean up observers</a> when they detect that elements have been removed from view to avoid memory leaks.</p>
			<p>Some sage advice from Derick Bailey:</p>
			<blockquote><p>“Other than being aware of how events work in terms of 
			references, just follow the standard rules for manage memory in 
			JavaScript and you’ll be fine. If you are loading data in to a Backbone 
			collection full of User objects you want that collection to be cleaned 
			up so it’s not using anymore memory, you must remove all references to 
			the collection and the individual objects in it. Once you remove all 
			references, things will be cleaned up. This is just the standard 
			JavaScript garbage collection rule.”</p></blockquote>
			<p>In his article, Derick covers many of the common <a class="ulink" href="http://lostechies.com/derickbailey/2012/03/19/backbone-js-and-javascript-garbage-collection/">memory pitfalls</a> when working with Backbone.js and how to fix them.</p>
			<p>There is also a helpful tutorial available for <a  class="ulink" href="https://github.com/felixge/node-memory-leak-tutorial">debugging memory leaks in Node</a> by Felix Geisendörfer worth reading, especially if it forms a part of your broader SPA stack.</p>

			<h4 id="minimizing-reflows">Minimizing Reflows <a class="ulink" href="#minimizing-reflows" aria-label="Link to section 'Minimizing Reflows'" class="sr hsl">Link</a></h4>
			<p>When a browser has to recalculate the positions and geometrics of 
			elements in a document for the purpose of re-rendering it, we call this <a class="ulink" href="https://www.youtube.com/watch?feature=player_embedded&amp;v=ZHxbs5WEQzE">reflow</a>. Reflow is a user-blocking operation in the browser, so it’s helpful to understand how to improve reflow time.</p>
			<p><div class="figure">
                <span id="constructorFunctions-diagram2" />
                <div class="figure-contents">
                    <img title="Chart Of Reflow Time" src="images/ch05_sec01_reflow.jpg" alt="Chart of reflow time." height="310" width="500">
                </div>
            </div><br>
			<em>Chart of reflow time.</em></p>
			<p>You should batch methods that <a class="ulink" href="http://stackoverflow.com/questions/510213/when-does-reflow-happen-in-a-dom-environment">trigger reflow</a> or that repaint, and use them sparingly. It’s important to process off DOM where possible. This is possible using <a class="ulink" href="http://www.w3.org/TR/DOM-Level-2-Core/core.html#ID-B63ED1A3">DocumentFragment</a>,
			 a lightweight document object. Think of it as a way to extract a 
			portion of a document’s tree, or create a new “fragment” of a document. 
			Rather than constantly adding to the DOM using nodes, we can use 
			document fragments to build up all we need and only perform a single 
			insert into the DOM to avoid excessive reflow.</p>
			<p>For example, let’s write a function that adds 20 <code>div</code>s to an element. Simply appending each new <code>div</code> directly to the element could trigger 20 reflows.</p>
<pre class=" language-javascript"><code class=" language-javascript"><span class="token keyword">function</span> <span class="token function">addDivs<span class="token punctuation">(</span></span>element<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> div<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    div <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement<span class="token punctuation">(</span></span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    div<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'Heya!'</span><span class="token punctuation">;</span>
    element<span class="token punctuation">.</span><span class="token function">appendChild<span class="token punctuation">(</span></span>div<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>

			<p>To work around this issue, we can use <code>DocumentFragment</code>, and instead, append each of our new <code>div</code>s to this. When appending to the <code>DocumentFragment</code> with a method like <code>appendChild</code>, all of the fragment’s children are appended to the element triggering only one reflow.</p>
<pre class=" language-javascript"><code class=" language-javascript"><span class="token keyword">function</span> <span class="token function">addDivs<span class="token punctuation">(</span></span>element<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> div<span class="token punctuation">;</span> 
 <span class="token comment" spellcheck="true"> // Creates a new empty DocumentFragment.
</span>  <span class="token keyword">var</span> fragment <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createDocumentFragment<span class="token punctuation">(</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    div <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement<span class="token punctuation">(</span></span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    div<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">'Heya!'</span><span class="token punctuation">;</span>
    fragment<span class="token punctuation">.</span><span class="token function">appendChild<span class="token punctuation">(</span></span>div<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  element<span class="token punctuation">.</span><span class="token function">appendChild<span class="token punctuation">(</span></span>fragment<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>

			<p>You can read more about this topic at <a class="ulink" href="https://developers.google.com/speed/articles/javascript-dom">Make the Web Faster</a>,<br>
			<a class="ulink" href="http://blog.tojicode.com/2012/03/javascript-memory-optimization-and.html">JavaScript Memory Optimization</a> and <a class="ulink" href="http://gent.ilcore.com/2011/08/finding-memory-leaks.html">Finding Memory Leaks</a>.</p>


			<h4 id="javascript-memory-leak-detector">JavaScript Memory Leak Detector <a class="ulink" href="#javascript-memory-leak-detector" aria-label="Link to section 'JavaScript Memory Leak Detector'" class="sr hsl">Link</a></h4>
			<p>To help discover JavaScript memory leaks, two of my fellow Googlers 
			(Marja Hölttä and Jochen Eisinger) developed a tool that works with the 
			Chrome Developer Tools (specifically, the remote inspection protocol), 
			and retrieves heap snapshots and detects what objects are causing leaks.</p>
			<p><div class="figure">
                <span id="constructorFunctions-diagram2" />
                <div class="figure-contents">
                    <img title="A Tool For Detecting JavaScript Memory Leaks" src="
                    images/ch05_sec01_leak.jpg" alt="A tool for detecting JavaScript memory leaks." height="271" width="500">
                </div>
            </div><br>
			<em>A tool for detecting JavaScript memory leaks.</em></p>
			<p>There’s a whole post on <a class="ulink" href="http://google-opensource.blogspot.de/2012/08/leak-finder-new-tool-for-javascript.html">how to use the tool</a>, and I encourage you to check it out or view the <a class="ulink" href="http://code.google.com/p/leak-finder-for-javascript/">Leak Finder project page</a>.</p>
			<p>Some more information: In case you’re wondering why a tool like this 
			isn’t already integrated with our Developer Tools, the reason is 
			twofold. It was originally developed to help us catch some specific 
			memory scenarios in the Closure Library, and it makes more sense as an 
			external tool (or maybe even an extension if we get a heap profiling 
			extension API in place).</p>

			<h4 id="v8-flags-for-debugging-optimizations-garbage-collection">V8 Flags for Debugging Optimizations &amp; Garbage Collection <a class="ulink" href="#v8-flags-for-debugging-optimizations-garbage-collection" aria-label="Link to section 'V8 Flags for Debugging Optimizations &amp; Garbage Collection'" class="sr hsl">Link</a></h4>
			<p>Chrome supports passing a number of flags directly to V8 via the <code>js-flags</code> flag to get more detailed output about what the engine is optimizing. For example, this traces V8 optimizations:</p>
<pre class=" language-javascript"><code class=" language-javascript"><span class="token string">"/Applications/Google Chrome/Google Chrome"</span> <span class="token operator">--</span>js<span class="token operator">-</span>flags<span class="token operator">=</span><span class="token string">"--trace-opt --trace-deopt"</span></code></pre>
			<p>Windows users will want to run <code>chrome.exe --js-flags="--trace-opt --trace-deopt"</code></p>
			<p>When developing your application, the following V8 flags can be used.</p>
			<ul>
			<li><code>trace-opt</code> – log names of optimized functions and show where the optimizer is skipping code because it can’t figure something out.</li>
			<li><code>trace-deopt</code> – log a list of code it had to deoptimize while running.</li>
			<li><code>trace-gc</code> – logs a tracing line on each garbage collection.</li>
			</ul>
			<p>V8’s tick-processing scripts mark optimized functions with an <code>*</code> (asterisk) and non-optimized functions with <code>~</code> (tilde).</p>
			<p>If you’re interested in learning more about V8’s flags and how V8’s 
			internals work in general, I strongly recommend looking through 
			Vyacheslav Egorov’s <a class="ulink" href="http://mrale.ph/blog/2011/12/18/v8-optimization-checklist.html">excellent post on V8 internals</a>, which summarizes the best resources available on this at the moment.</p>
			<h4 id="high-resolution-time-and-navigation-timing-api">High-Resolution Time and Navigation Timing API <a class="ulink" href="#high-resolution-time-and-navigation-timing-api" aria-label="Link to section 'High-Resolution Time and Navigation Timing API'" class="sr hsl">Link</a></h4>
			<p><a class="ulink" href="http://www.w3.org/TR/hr-time/">High Resolution Time</a>
			 (HRT) is a JavaScript interface providing the current time in 
			sub-millisecond resolution that isn’t subject to system clock skews or 
			user adjustments. Think of it as a way to measure more precisely than 
			we’ve previously had with <code>new Date</code> and <code>Date.now()</code>. This is helpful when we’re writing performance benchmarks.</p>
			<p><div class="figure">
                <span id="constructorFunctions-diagram2" />
                <div class="figure-contents">
                    <img title="High Resolution Time (HRT) Provides The Current Time In Sub-Millisecond Resolution" src="images/ch05_sec01_perfnow.jpg" alt="High Resolution Time (HRT) provides the current time in sub-millisecond resolution." height="143" width="500">
                </div>
            </div><br>
			<em>High Resolution Time (HRT) provides the current time in sub-millisecond resolution.</em></p>
			<p>HRT is currently available in Chrome (stable) as <code>window.performance.webkitNow()</code>, but the prefix is dropped in Chrome Canary, making it available via <code>window.performance.now()</code>. Paul Irish has written <a class="ulink" href="http://updates.html5rocks.com/2012/08/When-milliseconds-are-not-enough-performance-now">more about HRT</a> in a post on HTML5Rocks.</p>
			<p>So, we now know the current time, but what if we wanted an API for accurately measuring performance on the web?</p>
			<p>Well, one is now also available in the <a class="ulink" href="http://dvcs.w3.org/hg/webperf/raw-file/tip/specs/NavigationTiming/Overview.html">Navigation Timing API</a>.
			 This API provides a simple way to get accurate and detailed time 
			measurements that are recorded while a webpage is loaded and presented 
			to the user. Timing information is exposed via <code>window.performance.timing</code>, which you can simply use in the console:</p>
			<p><div class="figure">
                <span id="constructorFunctions-diagram2" />
                <div class="figure-contents">
                    <img title="Timing Information Is Shown In The Console" src="images/ch05_sec01_performance.jpg" alt="Timing information is shown in the console." height="292" width="500">
                </div>
            </div><br>
			<em>Timing information is shown in the console.</em></p>
			<p>Looking at the data above, we can extract some very useful information. For example, network latency is <code>responseEnd-fetchStart</code>, the time taken for a page load once it’s been received from the server is <code>loadEventEnd-responseEnd</code> and the time taken to process between navigation and page load is <code>loadEventEnd-navigationStart</code>.</p>
			<p>As you can see above, a <code>perfomance.memory</code> property is also available that gives access to JavaScript memory usage data such as the total heap size.</p>
			<p>For more details on the Navigation Timing API, read Sam Dutton’s great article <a class="ulink" href="http://www.html5rocks.com/en/tutorials/webperformance/basics/">Measuring Page Load Speed With Navigation Timing</a>.</p>


			<h4 id="aboutmemory-and-abouttracing">about:memory and about:tracing <a class="ulink" href="#aboutmemory-and-abouttracing" aria-label="Link to section 'about:memory and about:tracing'" class="sr hsl">Link</a></h4>
			<p><code>about:tracing</code> in Chrome offers an intimate view of the 
			browser’s performance, recording all of Chrome’s activities across every
			 thread, tab and process.</p>
			<p><div class="figure">
                <span id="constructorFunctions-diagram2" />
                <div class="figure-contents">
                    <img title="About:Tracing Offers An Intimate View Of The Browser’s Performance" src="images/ch05_sec01_tracing.jpg" alt="about:tracing offers an intimate view of the browser’s performance." height="275" width="500">
                </div>
            </div><br>
			<em><code>About:Tracing</code> offers an intimate view of the browser’s performance.</em></p>
			<p>What’s really useful about this tool is that it allows you to capture
			 profiling data about what Chrome is doing under the hood, so you can 
			properly adjust your JavaScript execution, or optimize your asset 
			loading.</p>
			<p>Lilli Thompson has an excellent <a class="ulink" href="http://www.html5rocks.com/en/tutorials/games/abouttracing/">write-up for games developers</a> on using <code>about:tracing</code> to profile WebGL games. The write-up is also useful for general JavaScripters.</p>
			<p>Navigating to <code>about:memory</code> in Chrome is also useful as 
			it shows the exact amount of memory being used by each tab, which is 
			helpful for tracking down potential leaks.</p>

		</div>
		<div class="sub_section">
			<h2 >Conclusion <a class="ulink" href="#conclusion" aria-label="Link to section 'Conclusion'" class="sr hsl">Link</a></h3>
			<p>As we’ve seen, <strong>there are many hidden performance gotchas in the world of JavaScript engines</strong>,
			 and no silver bullet available to improve performance. It’s only when 
			you combine a number of optimizations in a (real-world) testing 
			environment that you can realize the largest performance gains. But even
			 then, understanding how engines interpret and optimize your code can 
			give you insights to help tweak your applications.</p>
			<p><strong>Measure It. Understand it. Fix it.</strong> Rinse and repeat.</p>
			<p><a style="border: 0px none;" class="ulink" href="http://www.flickr.com/photos/38891164@N02/4266609887/"><div class="figure">
                <span id="constructorFunctions-diagram2" />
                <div class="figure-contents">
                    <img title="Measuring" src="images/ch05_sec01_barometer.jpg" alt="Measuring." height="320" width="480">
                </div>
            </div></a><br>
			<em>Image source: <a class="ulink" href="http://www.flickr.com/photos/38891164@N02/4266609887/">Sally Hunter</a>.</em></p>
			<p>Remember to care about optimization, but stop short of opting for 
			micro-optimization at the cost of convenience. For example, some 
			developers opt for <code>.forEach</code> and <code>Object.keys</code> over <code>for</code> and <code>for in</code>
			 loops, even though they’re slower, for the convenience of being able to
			 scope. Do make sanity calls on what optimizations your application 
			absolutely needs and which ones it could live without.</p>
			<p>Also, be aware that although JavaScript engines continue to get 
			faster, the next real bottleneck is the DOM. Reflows and repaints are 
			just as important to minimize, so remember to only touch the DOM if it’s
			 absolutely required. And do care about networking. HTTP requests are 
			precious, especially on mobile, and you should be using HTTP caching to 
			reduce the size of assets.</p>
			<p>Keeping all of these in mind will ensure that you get the most out of
			 the information from this post. I hope you found it helpful!</p>

		</div>

    </body>
</html>
